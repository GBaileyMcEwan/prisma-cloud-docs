== Prisma Cloud Compute certificates

This document summarizes all the certificates used by Prisma Cloud Compute. For each certificate, you can learn more about its functionallity, signing CA, and your customization options.

NOTE: Customizing certificates is only allowed for Prisma Cloud Compute edition.

[cols="10%a, 20%a, 10%a, 20%a, 10%a, 15%a, 15%a", options="header"]
|===
|Category  |Certificate  |Communication  |Certificate customizion  |Default CA |CA customizion  |Prisma Cloud edition

|Console TLS communication
|Console Web and API certificate
|Web browser, API and twistcli access to console
|Customize under *Manage > Authentication > System certificates > TLS certificate for Console > Concatenate public cert and private key*
|Console CA
|Your organization CA
|Compute edition, Enterprise edition

|xref:../access_control/rbac.adoc[Docker access control]
|Client certificates

To enforce Docker access control, client certs should be installed on any host where the docker client can be run.
|Clients (users) access to remote Docker Engine instances
|Customize your own certificates for your clients

Explicit list of trusted certificates can be defined under *Manage > Authentication > System certificates > Client certificates > Explicit certificate trust list*
|Console CA
|Customize under *Manage > Authentication > System certificates > Client certificates > CA certificate*
|Compute edition, Enterprise edition

|Certificate-based authentication to Console
|
|Clients access the Console 
|
|No CA by default
|Enable Console verification of the client's CA certificate when accessing the Console.

Define CA under *Manage > Authentication > System certificates > Certificate-based authentication to Console > CA certificate*
|Compute edition

|Console-Defender communication
|Defender server certificate (Console side)
|Console-Defender communication
|No
|Defender CA (defender-ca.pem)
|No
|Compute edition, not relevent for Enterprise edition (uses API token)

|Console-Defender communication
|Defender client certificate (Defender side)
|Console-Defender communication
|No
|Defender CA (defender-ca.pem)
|No
|Compute edition, not relevent for Enterprise edition (uses API token)

|xref:../access_control/open_policy_agent.adoc[Admission control]
|Admission certificate (admission-cert.pem)
|Admission webhook authentication with Prisma Cloud Defender
|No
|Defender CA (defender-ca.pem)
|No
|Compute edition, Enterprise edition

|===

=== Console TLS communication certificates
https://docs.paloaltonetworks.com/prisma/prisma-cloud/21-08/prisma-cloud-compute-edition-admin/configure/custom_certs_console_access.html

You can secure access to Console with your own digital certificate.
By default, Prisma Cloud secures access to Console’s web portal and API with a self-signed certificate.

[NOTE]
====
The self-managed certificate generated by Console is valid for three years.
90 days prior to expiration, Prisma Cloud will let you rotate it (a banner will appear at the top of the UI).
After rotating Console's certificate, you must manually redeploy your Defenders.

image::../_graphics/rotate_console_cert.png[width=600]
====

HTTP Public Key Pinning (HPKP) was a security feature that used to tell a web client to associate a specific cryptographic public key with a certain web server to decrease the risk of MITM attacks with forged certificates.
Deprecated: This feature is no longer recommended: https://developer.mozilla.org/en-US/docs/Web/HTTP/Public_Key_Pinning

=== Docker role-based access control certificates
https://docs.paloaltonetworks.com/prisma/prisma-cloud/21-08/prisma-cloud-compute-edition-admin/authentication/use_custom_certs_for_auth.html

These certificates settings are related to the xref:../access_control/rbac.adoc[Docker access control] feature. Using the Docker access control you can validate that Docker commands only run from remote machines through Defender on port 9998. Any user running Docker commands on port 9998 must be authenticated and authorized. By defult the Console generates certificates for users to authenticate to Defender. Any command run against Defender must also be explicitly allowed. 

Prisma Cloud lets you use your own certificates for Docker access control.
Customize the Docker access control certificates, by providing Prisma Cloud the CA that signs the clients (users) certificats. You can also specify an explicit list for Clents trasted certificates.  

*NOTES:*

* External certification authority section will be visible only to an Admin role user.
* All trusted certs information will be retrieved from the certificate itself, so the user doesn’t have to manually add info such as CN, issuer etc.
* Only the public portion of a user certificate should be added to the explicit trust list. Private keys are not required and should be excluded from this process.

[.task]
==== Setting up your custom certs

To set up your custom certs:

[.procedure]
. Open Console, and go to *Manage > Authentication > System certificates*.

. Open the *CA certificate* card

.. Under *CA certificat*, upload CA certificate to trust.

+
Once this configuration is enabled, users must copy their keys (both public and private) to the host they're using to run commands with docker or kubectl.
Though the path can be referenced in each command, it's usually simpler to place them in the default directory that docker looks in for certificates (~/.docker).

+
Each user certificate used with Prisma Cloud must have the user's CN embedded in the Subject field of the certificate.
You can validate these settings by running the following command against the certificate:

  $ openssl x509 -in .docker/cert.pem -text | grep Subj
  Subject: CN=username 
  
+  
Finally, Docker requires that the CA certificate used to sign the server certificate on the nodes Prisma Cloud is protecting must also be in the ~/.docker folder, in a file called ca.pem.
Because the 'server' certificate used in this deployment model is still generated by Prisma Cloud, this means that on each host where you're running docker or kubectl commands, you must also add the CA certificate to this folder.

+
. You can also choose to set *Explicit certificate trust list* to *ON* (this configuration is optional)

+
Explicit certificate trust list alows you to create a list of explicitly trusted custom certificates.
A typical use case of this feature would be when may have multiple certificates issued to a given user but only want specific ones to be available for use with Prisma Cloud.
By adding an explicit trust list, you can control what certificates can be used because Prisma Cloud compares any certificates presented to it against the allowed trusted-certificates-list.
This way, a user having certificate not in the explicitly allowed list will not be able to use the certificate with Prisma Cloud, even if it was issued by a trusted CA.
Note that this feature is valid only when custom CA is configured.
When enabled, it allows users to add new certificates to a table by uploading entire public certificates in PEM format.
+


. Click *Add certificate*, copy the PEM-formatted public certificate which was issued by the trusted CA, then click *Add*.

+
When a custom cert is provided to Prisma Cloud, it first checks the certificate against this list.
If the cert is matched to an entry in the list, then the previously existent flow continues.
If the cert is not in the trusted list, then the authentication fails with an error 'Certificate not in certificate trust list configured in Prisma Cloud'.
+

image::../_graphics/client-cert-editing.png[width=800]


=== Certificate-based authentication to Console
https://docs.paloaltonetworks.com/prisma/prisma-cloud/21-08/prisma-cloud-compute-edition-admin/authentication/use_custom_certs_for_auth.html

This feature allows the Console to verify the client’s CA certificate when accessing the Console. Use certificates from an implicitly trusted CA for securing the TLS connection.
To enable this feature follow the step below:
[.procedure]
. Open Console, and go to *Manage > Authentication > System Certificates*.

. Open the *Certificate-based authentication to Console* card

. Under *Console Authentication* upload the CA certificate(s) in PEM format, then click *Save*.
+
If you have multiple CAs, such as a root CA and several issuing CAs, you must add all these certificates into the PEM file.
The order of certificates in the PEM file should be from the lowest tier of the hierarchy to the root.
For example, if you have a 3 tier hierarchy that looks like this:
+
  ->RootCA
       ->IntermediateCA
            ->IssuingCA1
            ->IssuingCA2
+
Your PEM file should be ordered as IssuingCA1, IssuingCA2, IntermediateCA, RootCA.
To create such a PEM file, you'd get the public keys of each CA in PEM format and concatenate them together:
+
  $ cat IssuingCA1.pem IssuingCA2.pem IntermediateCA.pem RootCA.pem > CAs.pem

=== Console-Defender communication certificates

By design, Console and Defender don't trust each other and use a certificate-based authentication to connect. The certificates for Console-Defender communication are issued by the Defender CA (defender-ca.pem). The Defender CA is a self-signed CA generated by Prisma Cloud, and is valid for three years. This CA produces certificates for the Console (server) and the Defenders (clients) for their communication. 

One year before the Defeneder CA expires, Prisma Cloud automatically rotates the CA and its certificates. During the year after the rotation and before the old certificate expires, Prisma Cloud Console is able to communicate side-by-side with both Defenders with old certificate and Defenders with new certificate.

Each new Defender that is deployed after the rotation will automatically acquire the new certificate. In order to set the existing Defenders with the new certificate, they must be redeployed during the time before expiration. If the certificate expires, Defenders that won't get redeployed will not be able to establish a connection to Console on their next attempt to connect.

NOTE: Upgrade a single Defender from the Console UI does not replace the Defender's certificates. To set up a Defender with the new certificate you must manually redeploy it.

To identify which Defenders require redployment, go to *Manage > Defenders > Manage > Defenders*. Using the *Status* column, you will be able identify the Defenders that are using an old certificate. Use the note at the top of the page to understand how many Defenders require redeployment and when the old certificate will expire.

image::../_graphics/defenders_using_old_certs.png[width=800]

Use the *Using old certificate* filter on the Defenders list to see only the Defenders that are using an old certificate:

image::../_graphics/defenders_using_old_certs_filter.png[width=800]

If you still have Defenders in your environment that are using an old certificate, and it is about to expire in 60 days or less, you will get notified once entering the Console UI:

image::../_graphics/defenders_certs_top_banner.png[width=800]

If the old certificate has been expired, and you still have Defenders in your environment that are using the expired certificate, you will get notified once entering the Console UI. The *Status* column on the Defenders page will reflect the Defenders that are using an expired certificate. Use the *Certificate expired* filter on the Defenders list to see only the Defenders with expired certificate.

=== Admission control certificates

Prisma Cloud provides a dynamic admission controller for Kubernetes that is built on the Open Policy Agent (OPA). The admission control certificate is used for the authentication between the Defenders and the admission webhook. When deploying the admission webhook, make sure it is configured with the right CA bundle, according to the Defender's admission certificate. See the webhook configuration section on the xref:../access_control/open_policy_agent.adoc[admission control article].
